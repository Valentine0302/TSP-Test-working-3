<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Административная панель v4.5 - TSP Transport OÜ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .navbar {
            margin-bottom: 20px;
        }
        .tab-content {
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .form-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .alert {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TSP Transport OÜ - Административная панель v4.5</h1>
        </header>

        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ports-tab" data-bs-toggle="tab" data-bs-target="#ports" type="button" role="tab" aria-controls="ports" aria-selected="true">Порты</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="container-types-tab" data-bs-toggle="tab" data-bs-target="#container-types" type="button" role="tab" aria-controls="container-types" aria-selected="false">Типы контейнеров</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="indices-tab" data-bs-toggle="tab" data-bs-target="#indices" type="button" role="tab" aria-controls="indices" aria-selected="false">Индексы</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="base-rates-tab" data-bs-toggle="tab" data-bs-target="#base-rates" type="button" role="tab" aria-controls="base-rates" aria-selected="false">Базовые ставки</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calculations-tab" data-bs-toggle="tab" data-bs-target="#calculations" type="button" role="tab" aria-controls="calculations" aria-selected="false">История расчетов</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Настройки модели</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <!-- Область для общих сообщений об ошибках -->
            <div id="generalErrorDisplay"></div>

            <!-- Порты -->
            <div class="tab-pane fade show active" id="ports" role="tabpanel" aria-labelledby="ports-tab">
                <h2>Управление портами</h2>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#portModal" onclick="prepareAddPortModal()">Добавить порт</button>
                <div id="portsErrorDisplay"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="portsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Код</th>
                                <th>Регион</th>
                                <th>Страна</th>
                                <th>Широта</th>
                                <th>Долгота</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Типы контейнеров -->
            <div class="tab-pane fade" id="container-types" role="tabpanel" aria-labelledby="container-types-tab">
                <h2>Управление типами контейнеров</h2>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#containerTypeModal" onclick="prepareAddContainerTypeModal()">Добавить тип контейнера</button>
                <div id="containerTypesErrorDisplay"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="containerTypesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Описание</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Индексы -->
            <div class="tab-pane fade" id="indices" role="tabpanel" aria-labelledby="indices-tab">
                <h2>Индексы фрахтовых ставок</h2>
                <div class="form-section mb-3">
                    <h4>Загрузить индексы из Excel</h4>
                    <form id="uploadIndicesForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="indicesFile" class="form-label">Выберите Excel файл (.xlsx)</label>
                            <input class="form-control" type="file" id="indicesFile" name="indicesFile" accept=".xlsx" required>
                        </div>
                        <button type="submit" class="btn btn-success">Загрузить файл индексов</button>
                    </form>
                    <div id="indicesUploadStatus" class="mt-2"></div>
                </div>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#indexModal" onclick="prepareAddIndexModal()">Добавить индекс</button>
                <button type="button" class="btn btn-secondary mb-3" onclick="loadIndices()">Обновить таблицу индексов</button>
                <div id="indicesErrorDisplay"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="indicesTable">
                        <thead>
                            <tr>
                                <th>Индекс</th>
                                <th>Текущее значение</th>
                                <th>Базовое значение</th>
                                <th>Вес (%)</th>
                                <th>Дата обновления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Базовые ставки -->
            <div class="tab-pane fade" id="base-rates" role="tabpanel" aria-labelledby="base-rates-tab">
                <h2>Базовые ставки</h2>
                <div class="form-section mb-3">
                    <h4>Загрузить базовые ставки из Excel</h4>
                    <form id="uploadBaseRatesForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="baseRatesFile" class="form-label">Выберите Excel файл (.xlsx)</label>
                            <input class="form-control" type="file" id="baseRatesFile" name="baseRatesFile" accept=".xlsx" required>
                        </div>
                        <button type="submit" class="btn btn-success">Загрузить файл ставок</button>
                    </form>
                    <div id="baseRatesUploadStatus" class="mt-2"></div>
                </div>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#baseRateModal" onclick="prepareAddBaseRateModal()">Добавить ставку</button>
                <button type="button" class="btn btn-secondary mb-3" onclick="loadBaseRates()">Обновить таблицу ставок</button>
                <div id="baseRatesErrorDisplay"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="baseRatesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Регион отправления</th>
                                <th>Регион назначения</th>
                                <th>Тип контейнера</th>
                                <th>Ставка</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- История расчетов -->
            <div class="tab-pane fade" id="calculations" role="tabpanel" aria-labelledby="calculations-tab">
                <h2>История расчетов</h2>
                <button type="button" class="btn btn-secondary mb-3" onclick="loadCalculationHistory()">Обновить историю</button>
                <div id="calculationsErrorDisplay"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="calculationHistoryTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Время</th>
                                <th>Порт отпр. (Код)</th>
                                <th>Порт назн. (Код)</th>
                                <th>Тип конт.</th>
                                <th>Вес</th>
                                <th>Расч. ставка</th>
                                <th>Email</th>
                                <th>Исп. индексы</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут загружены через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Настройки модели -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <h2>Настройки модели расчета</h2>
                <div id="settingsErrorDisplay"></div>
                <div id="settingsForm">
                    <!-- Настройки будут загружены через JavaScript -->
                </div>
                <button type="button" class="btn btn-primary mt-3" onclick="saveSettings()">Сохранить настройки</button>
                <div id="settingsStatus" class="mt-2"></div>
            </div>

        </div> <!-- /tab-content -->

        <!-- Модальное окно для Портов -->
        <div class="modal fade" id="portModal" tabindex="-1" aria-labelledby="portModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="portModalLabel">Добавить/Редактировать Порт</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="portForm">
                            <input type="hidden" id="portId">
                            <div class="mb-3">
                                <label for="portName" class="form-label">Название</label>
                                <input type="text" class="form-control" id="portName" required>
                            </div>
                            <div class="mb-3">
                                <label for="portCode" class="form-label">Код (необязательно, но уникально)</label>
                                <input type="text" class="form-control" id="portCode">
                            </div>
                            <div class="mb-3">
                                <label for="portRegion" class="form-label">Регион</label>
                                <input type="text" class="form-control" id="portRegion">
                            </div>
                            <div class="mb-3">
                                <label for="portCountry" class="form-label">Страна</label>
                                <input type="text" class="form-control" id="portCountry">
                            </div>
                            <div class="mb-3">
                                <label for="portLatitude" class="form-label">Широта</label>
                                <input type="number" step="any" class="form-control" id="portLatitude">
                            </div>
                            <div class="mb-3">
                                <label for="portLongitude" class="form-label">Долгота</label>
                                <input type="number" step="any" class="form-control" id="portLongitude">
                            </div>
                        </form>
                        <div id="portModalError" class="error-message"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="button" class="btn btn-primary" onclick="savePort()">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно для Типов Контейнеров -->
        <div class="modal fade" id="containerTypeModal" tabindex="-1" aria-labelledby="containerTypeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="containerTypeModalLabel">Добавить/Редактировать Тип Контейнера</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="containerTypeForm">
                            <input type="hidden" id="containerTypeId">
                            <div class="mb-3">
                                <label for="containerTypeName" class="form-label">Название (например, 20GP, 40HC)</label>
                                <input type="text" class="form-control" id="containerTypeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="containerTypeDescription" class="form-label">Описание</label>
                                <textarea class="form-control" id="containerTypeDescription" rows="3"></textarea>
                            </div>
                        </form>
                        <div id="containerTypeModalError" class="error-message"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="button" class="btn btn-primary" onclick="saveContainerType()">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно для Индексов -->
        <div class="modal fade" id="indexModal" tabindex="-1" aria-labelledby="indexModalLabel" aria-hidden="true">
             <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="indexModalLabel">Добавить/Редактировать Индекс</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="indexForm">
                            <input type="hidden" id="indexNameOriginal"> <!-- Для PUT запроса -->
                            <div class="mb-3">
                                <label for="indexName" class="form-label">Название индекса</label>
                                <input type="text" class="form-control" id="indexName" required>
                            </div>
                            <div class="mb-3">
                                <label for="indexCurrentValue" class="form-label">Текущее значение</label>
                                <input type="number" step="any" class="form-control" id="indexCurrentValue" required>
                            </div>
                            <div class="mb-3">
                                <label for="indexBaselineValue" class="form-label">Базовое значение</label>
                                <input type="number" step="any" class="form-control" id="indexBaselineValue" required>
                            </div>
                            <div class="mb-3">
                                <label for="indexWeightPercentage" class="form-label">Вес (%)</label>
                                <input type="number" step="any" class="form-control" id="indexWeightPercentage" required min="0" max="100">
                            </div>
                        </form>
                        <div id="indexModalError" class="error-message"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="button" class="btn btn-primary" onclick="saveIndex()">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно для Базовых Ставок -->
         <div class="modal fade" id="baseRateModal" tabindex="-1" aria-labelledby="baseRateModalLabel" aria-hidden="true">
             <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="baseRateModalLabel">Добавить/Редактировать Базовую Ставку</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="baseRateForm">
                            <input type="hidden" id="baseRateId">
                            <div class="mb-3">
                                <label for="baseRateOriginRegion" class="form-label">Регион отправления</label>
                                <input type="text" class="form-control" id="baseRateOriginRegion" required>
                            </div>
                            <div class="mb-3">
                                <label for="baseRateDestinationRegion" class="form-label">Регион назначения</label>
                                <input type="text" class="form-control" id="baseRateDestinationRegion" required>
                            </div>
                            <div class="mb-3">
                                <label for="baseRateContainerType" class="form-label">Тип контейнера</label>
                                <select class="form-select" id="baseRateContainerType" required>
                                    <!-- Опции будут загружены -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="baseRateRate" class="form-label">Ставка</label>
                                <input type="number" step="any" class="form-control" id="baseRateRate" required>
                            </div>
                        </form>
                        <div id="baseRateModalError" class="error-message"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="button" class="btn btn-primary" onclick="saveBaseRate()">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>


    </div> <!-- /container -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = "."; // Используем относительный путь к API
        let portModalInstance, containerTypeModalInstance, indexModalInstance, baseRateModalInstance;

        document.addEventListener("DOMContentLoaded", function () {
            portModalInstance = new bootstrap.Modal(document.getElementById("portModal"));
            containerTypeModalInstance = new bootstrap.Modal(document.getElementById("containerTypeModal"));
            indexModalInstance = new bootstrap.Modal(document.getElementById("indexModal"));
            baseRateModalInstance = new bootstrap.Modal(document.getElementById("baseRateModal"));

            loadPorts();
            loadContainerTypes();
            loadIndices();
            loadBaseRates();
            loadCalculationHistory();
            loadSettings();
            loadContainerTypesForDropdown(); // Загрузка типов для модального окна ставок

            // Обработчики для форм загрузки Excel
            document.getElementById("uploadIndicesForm").addEventListener("submit", uploadIndicesFile);
            document.getElementById("uploadBaseRatesForm").addEventListener("submit", uploadBaseRatesFile);

            // Обновление данных при переключении вкладок
            const adminTabs = document.querySelectorAll("#adminTabs button[data-bs-toggle=\"tab\"]");
            adminTabs.forEach(tab => {
                tab.addEventListener("shown.bs.tab", event => {
                    const targetId = event.target.getAttribute("data-bs-target");
                    clearAllErrors(); // Очищаем ошибки при смене вкладки
                    if (targetId === "#ports") loadPorts();
                    else if (targetId === "#container-types") loadContainerTypes();
                    else if (targetId === "#indices") loadIndices();
                    else if (targetId === "#base-rates") loadBaseRates();
                    else if (targetId === "#calculations") loadCalculationHistory();
                    else if (targetId === "#settings") loadSettings();
                });
            });
        });

        // --- Общие функции --- 
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: await response.text() || response.statusText };
                    }
                    console.error(`HTTP error! status: ${response.status}`, errorData);
                    // Формируем более детальное сообщение об ошибке
                    let errorMessage = `HTTP ${response.status}: ${errorData.error || "Unknown error"}`;
                    if (errorData.detail) {
                        errorMessage += ` (${errorData.detail})`;
                    }
                    throw new Error(errorMessage);
                }
                // Обработка случая, когда ответ пустой (например, при DELETE с кодом 204)
                if (response.status === 204 || response.headers.get("content-length") === "0") {
                    return { success: true }; // Возвращаем индикатор успеха
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch error:", error);
                throw error; // Перебрасываем ошибку дальше
            }
        }

        function displayError(elementId, error) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    Ошибка: ${error.message || error}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                 </div>`;
            }
        }

        function displaySuccess(elementId, message) {
             const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                 </div>`;
                // Убрал авто-скрытие, т.к. есть кнопка закрытия
            }
        }

        function displayModalError(modalErrorElementId, error) {
            const element = document.getElementById(modalErrorElementId);
            if (element) {
                element.textContent = `Ошибка: ${error.message || error}`;
            }
        }

        function clearModalError(modalErrorElementId) {
             const element = document.getElementById(modalErrorElementId);
            if (element) {
                element.textContent = "";
            }
        }

        function clearAllErrors() {
            const errorDisplays = ["generalErrorDisplay", "portsErrorDisplay", "containerTypesErrorDisplay", "indicesErrorDisplay", "baseRatesErrorDisplay", "calculationsErrorDisplay", "settingsErrorDisplay", "settingsStatus", "indicesUploadStatus", "baseRatesUploadStatus"];
            errorDisplays.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = "";
            });
            const modalErrorDisplays = ["portModalError", "containerTypeModalError", "indexModalError", "baseRateModalError"];
             modalErrorDisplays.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = "";
            });
        }

        function sanitizeHTML(str) {
            if (str === null || str === undefined) return "";
            const temp = document.createElement("div");
            temp.textContent = str;
            return temp.innerHTML;
        }

        // --- Порты --- 
        async function loadPorts() {
            try {
                const ports = await fetchData(`${API_BASE_URL}/api/admin/ports`);
                const tableBody = document.getElementById("portsTable").querySelector("tbody");
                tableBody.innerHTML = ""; // Очистка таблицы
                ports.forEach(port => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${sanitizeHTML(port.id)}</td>
                        <td>${sanitizeHTML(port.name)}</td>
                        <td>${sanitizeHTML(port.code) || "-"}</td>
                        <td>${sanitizeHTML(port.region) || "-"}</td>
                        <td>${sanitizeHTML(port.country) || "-"}</td>
                        <td>${sanitizeHTML(port.latitude) || "-"}</td>
                        <td>${sanitizeHTML(port.longitude) || "-"}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editPort(${port.id})">Ред.</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePort(${port.id})">Удал.</button>
                        </td>
                    `;
                });
            } catch (error) {
                displayError("portsErrorDisplay", error);
            }
        }

        function prepareAddPortModal() {
            document.getElementById("portForm").reset();
            document.getElementById("portId").value = "";
            document.getElementById("portModalLabel").textContent = "Добавить Порт";
            clearModalError("portModalError");
            // portModalInstance.show(); // Не нужно, т.к. data-bs-toggle="modal" уже есть
        }

        async function editPort(id) {
            clearModalError("portModalError");
            try {
                const port = await fetchData(`${API_BASE_URL}/api/admin/ports/${id}`);
                document.getElementById("portId").value = port.id;
                document.getElementById("portName").value = port.name;
                document.getElementById("portCode").value = port.code || "";
                document.getElementById("portRegion").value = port.region || "";
                document.getElementById("portCountry").value = port.country || "";
                document.getElementById("portLatitude").value = port.latitude || "";
                document.getElementById("portLongitude").value = port.longitude || "";
                document.getElementById("portModalLabel").textContent = "Редактировать Порт";
                portModalInstance.show();
            } catch (error) {
                displayError("portsErrorDisplay", `Ошибка при загрузке данных порта для редактирования: ${error.message}`);
            }
        }

        async function savePort() {
            clearModalError("portModalError");
            const portId = document.getElementById("portId").value;
            const portData = {
                name: document.getElementById("portName").value,
                code: document.getElementById("portCode").value || null, // Отправляем null если пусто
                region: document.getElementById("portRegion").value || null,
                country: document.getElementById("portCountry").value || null,
                latitude: document.getElementById("portLatitude").value || null,
                longitude: document.getElementById("portLongitude").value || null,
            };

            // Простая валидация на клиенте
            if (!portData.name) {
                displayModalError("portModalError", "Название порта обязательно.");
                return;
            }

            const url = portId ? `${API_BASE_URL}/api/admin/ports/${portId}` : `${API_BASE_URL}/api/admin/ports`;
            const method = portId ? "PUT" : "POST";

            try {
                await fetchData(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(portData)
                });
                portModalInstance.hide();
                loadPorts(); // Обновить таблицу
            } catch (error) {
                displayModalError("portModalError", error);
            }
        }

        async function deletePort(id) {
            if (!confirm(`Вы уверены, что хотите удалить порт с ID ${id}?`)) return;
            try {
                await fetchData(`${API_BASE_URL}/api/admin/ports/${id}`, { method: "DELETE" });
                loadPorts(); // Обновить таблицу
            } catch (error) {
                displayError("portsErrorDisplay", `Ошибка при удалении порта: ${error.message}`);
            }
        }

        // --- Типы контейнеров --- 
        async function loadContainerTypes() {
            try {
                const types = await fetchData(`${API_BASE_URL}/api/admin/container-types`);
                const tableBody = document.getElementById("containerTypesTable").querySelector("tbody");
                tableBody.innerHTML = "";
                types.forEach(type => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${sanitizeHTML(type.id)}</td>
                        <td>${sanitizeHTML(type.name)}</td>
                        <td>${sanitizeHTML(type.description) || "-"}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editContainerType(${type.id})">Ред.</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteContainerType(${type.id})">Удал.</button>
                        </td>
                    `;
                });
            } catch (error) {
                 displayError("containerTypesErrorDisplay", error);
            }
        }

        function prepareAddContainerTypeModal() {
            document.getElementById("containerTypeForm").reset();
            document.getElementById("containerTypeId").value = "";
            document.getElementById("containerTypeModalLabel").textContent = "Добавить Тип Контейнера";
            clearModalError("containerTypeModalError");
        }

        async function editContainerType(id) {
            clearModalError("containerTypeModalError");
            try {
                const type = await fetchData(`${API_BASE_URL}/api/admin/container-types/${id}`);
                document.getElementById("containerTypeId").value = type.id;
                document.getElementById("containerTypeName").value = type.name;
                document.getElementById("containerTypeDescription").value = type.description || "";
                document.getElementById("containerTypeModalLabel").textContent = "Редактировать Тип Контейнера";
                containerTypeModalInstance.show();
            } catch (error) {
                displayError("containerTypesErrorDisplay", `Ошибка при загрузке данных типа контейнера: ${error.message}`);
            }
        }

        async function saveContainerType() {
            clearModalError("containerTypeModalError");
            const typeId = document.getElementById("containerTypeId").value;
            const typeData = {
                name: document.getElementById("containerTypeName").value,
                description: document.getElementById("containerTypeDescription").value || null
            };

            if (!typeData.name) {
                displayModalError("containerTypeModalError", "Название типа обязательно.");
                return;
            }

            const url = typeId ? `${API_BASE_URL}/api/admin/container-types/${typeId}` : `${API_BASE_URL}/api/admin/container-types`;
            const method = typeId ? "PUT" : "POST";

            try {
                await fetchData(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(typeData)
                });
                containerTypeModalInstance.hide();
                loadContainerTypes(); // Обновить таблицу
                loadContainerTypesForDropdown(); // Обновить выпадающий список в ставках
            } catch (error) {
                displayModalError("containerTypeModalError", error);
            }
        }

        async function deleteContainerType(id) {
            // Получаем имя для подтверждения (не обязательно, но полезно)
            let typeName = `ID ${id}`;
            try {
                const type = await fetchData(`${API_BASE_URL}/api/admin/container-types/${id}`);
                typeName = type.name;
            } catch (e) { /* Игнорируем ошибку получения имени */ }

            if (!confirm(`Вы уверены, что хотите удалить тип контейнера '${typeName}'? Это возможно только если он не используется.`)) return;
            
            try {
                await fetchData(`${API_BASE_URL}/api/admin/container-types/${id}`, { method: "DELETE" });
                loadContainerTypes(); // Обновить таблицу
                loadContainerTypesForDropdown(); // Обновить выпадающий список в ставках
            } catch (error) {
                displayError("containerTypesErrorDisplay", `Ошибка при удалении типа контейнера: ${error.message}`);
            }
        }

        // --- Индексы --- 
        async function loadIndices() {
            try {
                const indices = await fetchData(`${API_BASE_URL}/api/admin/index-config`);
                const tableBody = document.getElementById("indicesTable").querySelector("tbody");
                tableBody.innerHTML = "";
                indices.forEach(index => {
                    const row = tableBody.insertRow();
                    const lastUpdated = index.last_updated ? new Date(index.last_updated).toLocaleString() : "-";
                    row.innerHTML = `
                        <td>${sanitizeHTML(index.index_name)}</td>
                        <td>${sanitizeHTML(index.current_value) ?? "-"}</td>
                        <td>${sanitizeHTML(index.baseline_value) ?? "-"}</td>
                        <td>${sanitizeHTML(index.weight_percentage) ?? "-"}</td>
                        <td>${lastUpdated}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editIndex(\'${sanitizeHTML(index.index_name)}\')">Ред.</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteIndex(\'${sanitizeHTML(index.index_name)}\')">Удал.</button>
                        </td>
                    `;
                });
            } catch (error) {
                 displayError("indicesErrorDisplay", error);
            }
        }

        async function uploadIndicesFile(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const statusDiv = document.getElementById("indicesUploadStatus");
            statusDiv.innerHTML = 
(Content truncated due to size limit. Use line ranges to read in chunks)
